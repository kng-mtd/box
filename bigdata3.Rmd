---
title: "bigdata"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=F}
knitr::opts_chunk$set(echo=T,warning=F,message=F)
options(digits=2)
library(arrow)
library(duckdb)
```


```{r}
if(F){
  
rm(list=ls())

#make duckdb database from csv

db=dbConnect(duckdb(),'./db1.duck')
system.time({
duckdb_read_csv(db,name='table0',files='big.csv',header=T)
},T)
dbDisconnect(db)
rm(db)

db=dbConnect(duckdb(),'./db2.duck')
system.time({
duckdb_read_csv(db,name='table0',files='big2.csv',header=T)
},T)
dbDisconnect(db)
rm(db)

db=dbConnect(duckdb(),'./db4.duck')
system.time({
duckdb_read_csv(db,name='table0',files='big4.csv',header=T)
},T)
dbDisconnect(db)
rm(db)

}
```

csv(1e8 rows) 6.6GB -> duckdb 2.6GB

   ユーザ   システム       経過  
      86.9        5.2       35.8 

csv(2e8 rows) 13.2GB -> duckdb 5.2GB

   ユーザ   システム       経過  
       157         12         85 

csv(4e8 rows) 26.4GB -> duckdb 10.4GB

   ユーザ   システム       経過  
       193         14        238 

```{r}
db=dbConnect(duckdb(),'./db1.duck')
vtb=tbl(db,'table0')

system.time({
  head(vtb) %>% print()
},T)

system.time({
  vtb %>% group_by(c1) %>%
    summarise(n(),mean(x1),sd(x1)) %>%
    print()
},T)

system.time({
  vtb %>% mutate(xx=x1*x2*x3) %>% 
    group_by(c1,c2,c3) %>%
    summarise(n(),
              mean(x1),sd(x1),
              mean(x2),sd(x2),
              mean(x3),sd(x3),
              mean(xx),sd(xx)) %>% 
    print()
},T)

dbDisconnect(db)
rm(db)


db=dbConnect(duckdb(),'./db2.duck')
vtb=tbl(db,'table0')

system.time({
  head(vtb) %>% print()
},T)

system.time({
  vtb %>% group_by(c1) %>%
    summarise(n(),mean(x1),sd(x1)) %>%
    print()
},T)

system.time({
  vtb %>% mutate(xx=x1*x2*x3) %>% 
    group_by(c1,c2,c3) %>%
    summarise(n(),
              mean(x1),sd(x1),
              mean(x2),sd(x2),
              mean(x3),sd(x3),
              mean(xx),sd(xx)) %>% 
    print()
},T)

dbDisconnect(db)
rm(db)


db=dbConnect(duckdb(),'./db4.duck')
vtb=tbl(db,'table0')

system.time({
  head(vtb) %>% print()
},T)

system.time({
  vtb %>% group_by(c1) %>%
    summarise(n(),mean(x1),sd(x1)) %>%
    print()
},T)

system.time({
  vtb %>% mutate(xx=x1*x2*x3) %>% 
    group_by(c1,c2,c3) %>%
    summarise(n(),
              mean(x1),sd(x1),
              mean(x2),sd(x2),
              mean(x3),sd(x3),
              mean(xx),sd(xx)) %>% 
    print()
},T)

dbDisconnect(db)
rm(db)

```

1e8
   ユーザ   システム       経過  
      0.02       0.03       0.07 

   ユーザ   システム       経過  
      0.38       0.18       0.69 

   ユーザ   システム       経過  
      0.82       0.18       1.60 

   c1    c2    c3     `n()` `mean(x1)` `sd(x1)` `mean(x2)` `sd(x2)` `mean(x3)` `sd(x3)` `mean(xx)` `sd(xx)`
   <chr> <chr> <chr>  <dbl>      <dbl>    <dbl>      <dbl>    <dbl>      <dbl>    <dbl>      <dbl>    <dbl>
 1 b     c     b     800796  0.00202      1.00    0.00112     1.00  -0.00183      0.999  -0.00106     1.00 
 2 a     d     e     798750 -0.00251      0.999   0.00130     1.00  -0.000591     1.00   -0.000393    0.999
 3 b     e     d     801309  0.000967     1.00    0.000489    1.00  -0.00101      1.00    0.000486    1.00 
 4 b     e     a     800772  0.000273     1.00    0.000273    1.00   0.00253      1.00   -0.00201     1.00 
 5 b     d     d     799619 -0.00232      1.00   -0.00291     1.00   0.000409     0.999   0.000631    1.00 
 6 c     d     d     799188  0.00101      1.00   -0.000742    0.999 -0.000563     1.00   -0.00294     1.00 
 7 a     d     d     799557 -0.0000953    0.999   0.000229    1.00   0.0000993    1.00    0.00124     0.996
 8 d     e     b     801864 -0.000991     1.00   -0.000783    0.999 -0.00220      1.00   -0.000721    0.995
 9 b     b     b     801025 -0.000481     1.00   -0.00277     0.997 -0.00106      1.00    0.00152     1.00 
10 c     a     b     800560 -0.000530     1.00    0.000524    0.999 -0.00113      1.00    0.00178     0.999
# ℹ more rows


2e8
   ユーザ   システム       経過  
      0.00       0.03       0.08 

   ユーザ   システム       経過  
      0.51       0.20       4.42 

   ユーザ   システム       経過  
       1.8        1.0        8.5 

   c1    c2    c3      `n()` `mean(x1)` `sd(x1)` `mean(x2)` `sd(x2)`  `mean(x3)` `sd(x3)`  `mean(xx)` `sd(xx)`
   <chr> <chr> <chr>   <dbl>      <dbl>    <dbl>      <dbl>    <dbl>       <dbl>    <dbl>       <dbl>    <dbl>
 1 b     b     a     1598880 -0.000496     1.00    0.000245    0.998 -0.000292      1.00   0.000306      1.00 
 2 c     a     d     1600174  0.00122      1.00   -0.000506    1.00   0.000621      1.00   0.00141       1.00 
 3 e     d     b     1599458  0.000719     1.00    0.000980    1.00  -0.00000670    1.00  -0.00000702    0.998
 4 a     e     a     1600650 -0.00154      0.999  -0.00113     1.00  -0.000181      1.00   0.000828      0.998
 5 c     c     b     1601958  0.000847     1.00   -0.00243     0.998  0.000748      1.00  -0.0000647     1.00 
 6 b     d     c     1598238 -0.0000840    0.999  -0.00129     0.999  0.000194      0.999 -0.00169       0.997
 7 d     c     a     1600320  0.000586     1.00   -0.000380    1.00  -0.00174       1.00  -0.000287      1.00 
 8 e     a     c     1601164  0.000722     0.999  -0.00140     0.999  0.000528      1.00  -0.000256      0.999
 9 a     c     a     1600090  0.00138      1.00   -0.000619    1.00   0.000651      1.00   0.000306      1.00 
10 c     a     c     1595440 -0.000516     1.00   -0.000896    1.00  -0.000129      1.00   0.000172      0.996
# ℹ more rows


4e8
   ユーザ   システム       経過  
      0.04       0.00       0.08 

   ユーザ   システム       経過  
      0.87       0.34       8.35 

   ユーザ   システム       経過  
       3.0        0.8       16.6 

   c1    c2    c3      `n()` `mean(x1)` `sd(x1)` `mean(x2)` `sd(x2)`  `mean(x3)` `sd(x3)`  `mean(xx)` `sd(xx)`
   <chr> <chr> <chr>   <dbl>      <dbl>    <dbl>      <dbl>    <dbl>       <dbl>    <dbl>       <dbl>    <dbl>
 1 e     d     c     3194660   0.000533    0.999  -0.000396    1.00   0.000280      1.00   0.00230       1.00 
 2 a     e     e     3197912   0.00149     1.00    0.000295    1.00  -0.00129       1.00   0.000944      1.00 
 3 c     e     b     3199476   0.000269    0.999   0.000450    1.00   0.00206       1.00  -0.00114       1.00 
 4 e     a     a     3204260   0.00108     1.00   -0.000726    1.00  -0.00238       1.00  -0.000882      0.999
 5 d     a     e     3202476   0.000230    1.00   -0.00196     1.00   0.000902      0.999  0.00148       1.00 
 6 b     e     d     3198336   0.000949    0.999   0.000884    0.999 -0.000852      1.00  -0.000940      1.00 
 7 c     b     d     3203252   0.000177    0.999  -0.000289    1.00  -0.00257       1.00  -0.000557      0.995
 8 e     d     b     3198916   0.000719    1.00    0.000980    1.00  -0.00000670    1.00  -0.00000702    0.998
 9 d     e     b     3202072  -0.00146     0.999   0.00166     1.00   0.000350      1.00   0.0000979     1.00 
10 a     d     d     3202976   0.000991    0.999   0.000143    1.00  -0.000930      0.999  0.000599      1.00 
# ℹ more rows